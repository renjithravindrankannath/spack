From 4fae9ad50990c63c949b2f82d0f0dbd5c911aa4b Mon Sep 17 00:00:00 2001
From: Renjith Ravindran <Renjith.RavindranKannath@amd.com>
Date: Thu, 13 Oct 2022 07:26:15 +0000
Subject: [PATCH] New patch for 5.3.0 ROCm release

---
 bin/hipcc.pl               |  3 ++-
 hipamd/CMakeLists.txt      | 10 ++++++++--
 hipamd/hip-config.cmake.in |  1 -
 3 files changed, 10 insertions(+), 4 deletions(-)

diff --git a/bin/hipcc.pl b/bin/hipcc.pl
index 645ae62..d3cf824 100755
--- a/bin/hipcc.pl
+++ b/bin/hipcc.pl
@@ -612,7 +612,8 @@ if($HIP_PLATFORM eq "amd"){
             $targetsStr = $ENV{HCC_AMDGPU_TARGET};
         } elsif (not $isWindows) {
             # Else try using rocm_agent_enumerator
-            $ROCM_AGENT_ENUM = "${ROCM_PATH}/bin/rocm_agent_enumerator";
+            $ROCMINFO_PATH = $ENV{'ROCMINFO_PATH'} // $ROCM_PATH;
+            $ROCM_AGENT_ENUM = "${ROCMINFO_PATH}/bin/rocm_agent_enumerator";
             $targetsStr = `${ROCM_AGENT_ENUM} -t GPU`;
             $targetsStr =~ s/\n/,/g;
         }
diff --git a/hipamd/CMakeLists.txt b/hipamd/CMakeLists.txt
index bb91e9d..5454952 100755
--- a/hipamd/CMakeLists.txt
+++ b/hipamd/CMakeLists.txt
@@ -93,7 +93,13 @@ string(REPLACE "-" ";" VERSION_LIST ${HIP_VERSION_PATCH_GITHASH})
 list(GET VERSION_LIST 0 HIP_VERSION_PATCH)
 set(HIP_VERSION_GITDATE 0)
 
-find_package(Git)
+if (IS_DIRECTORY "${PROJECT_SOURCE_DIR}/.git")
+  find_package(Git)
+endif()
+set(HIP_VERSION_GITDATE "0")
+set(HIP_VERSION_GITHASH "0")
+set(HIP_VERSION_BUILD_ID 0)
+set(HIP_VERSION_BUILD_NAME "")
 
 # FIXME: Two different version strings used.
 # Below we use UNIX commands, not compatible with Windows.
@@ -187,7 +193,7 @@ set (HIP_LIB_VERSION_MINOR ${HIP_VERSION_MINOR})
 if (${ROCM_PATCH_VERSION} )
    set (HIP_LIB_VERSION_PATCH ${ROCM_PATCH_VERSION})
 elseif (DEFINED HIP_VERSION_GITHASH)
-   set (HIP_LIB_VERSION_PATCH ${HIP_VERSION_PATCH}-${HIP_VERSION_GITHASH})
+   set (HIP_LIB_VERSION_PATCH "0")
 else ()
    set (HIP_LIB_VERSION_PATCH ${HIP_VERSION_PATCH})
 endif ()
diff --git a/hipamd/hip-config.cmake.in b/hipamd/hip-config.cmake.in
index 89d1224..8c4f9b7 100755
--- a/hipamd/hip-config.cmake.in
+++ b/hipamd/hip-config.cmake.in
@@ -306,7 +306,6 @@ if(HIP_COMPILER STREQUAL "clang")
   if(NOT CLANGRT_BUILTINS)
     message(FATAL_ERROR "clangrt builtins lib not found")
   else()
-    set_property(TARGET hip::host APPEND PROPERTY INTERFACE_LINK_LIBRARIES "${CLANGRT_BUILTINS}")
     set_property(TARGET hip::device APPEND PROPERTY INTERFACE_LINK_LIBRARIES "${CLANGRT_BUILTINS}")
   endif()
 endif()
-- 
2.17.1

